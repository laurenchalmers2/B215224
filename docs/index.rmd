---
title: "Assessment"
output: html_document
date: "2025-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Loading in prescription data sets and health board names from open nhs data. Loading census education data and cleaning names. Using skip function, so R only reads 

```{r}
library(tidyverse)
library(janitor)
library(here)


july_2025_data <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f02161c1-15f6-4d9f-8be5-01ba613d4303/download/hb_pitc2025_07.csv") %>% 
  clean_names()

health_board_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

```

Joining prescription Dataset from July 2025, with health boards names. Selecting columns with health board names, the item prescribed and the quantity in which they were prescribed. Filtered using string detect to identify just antibiotic prescriptions, since they all end in 'illin'.

Removing rows where there is no info about health board names 
```{r}
Health_board_data_2025 <- july_2025_data %>%
  left_join(health_board_names, by = join_by(hbt == hb)) 

missing_values <- Health_board_data_2025%>%
  filter(is.na(hb_name))
```

Wrangling with population data to compare with prescription health board data
```{r}
population_data <- read_csv(here("data", "healthboardpopulationbyage.csv"), skip = 10) %>% 
  clean_names() %>% 
rename(Spare = "x6",
         hb_name = "health_board_area_2019",
         hb_population = count) %>% 
  filter(age == "All people" & sex == "All people") %>% 
         select(hb_name, hb_population) %>%
        mutate(hb_name = paste("NHS", hb_name)) 
  
```

Joining Population with prescription data 
```{r}
population_2025_health_data <-  population_data %>%
  left_join(Health_board_data_2025, by = join_by(hb_name == hb_name))

```

Grouping data by tyope of prescription anf filtering prescriptions to only see antibiotic prescriptions. Totalling up number of antibiotics for each healthboard.
```{r}
health_board_2025_population_antibiotics <- population_2025_health_data %>% 
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  group_by(hb_name, bnf_item_description) %>% 
  summarise(paid_quantity = sum(paid_quantity)) 

```
Joining with population data to determine number of antibiotics per person in each health board
```{r}
antibiotics_2025_data <- health_board_2025_population_antibiotics %>% 
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  left_join(population_data) %>% 
  mutate(antibiotics_per_person = paid_quantity/hb_population) %>% 
  arrange(desc(antibiotics_per_person))
```

```{r}
library(forcats)

p2025 <- antibiotics_2025_data %>%
  mutate(hb_name = fct_reorder(hb_name, antibiotics_per_person)) %>%  # reorder factor by antibiotics_per_person ascending
  ggplot(aes(x = hb_name, y = antibiotics_per_person, colour = hb_name, fill = hb_name)) +
  geom_col() +
  labs(
    x = "Health Board Name",
    y = "Number of Antibiotics per person in July 2025",
    title = "Number of Antibiotics Prescribed per person in July 2025"
  )

```

```{r}
population <- read_csv(here("data", "healthboardpopulationbyage.csv"), skip = 10) %>% 
  clean_names()
```

Tidying up population data

```{r}
population <- population %>% 
  rename(Spare = "x6",
         hb_name = "health_board_area_2019",
         hb_population = count) %>% 
  filter(age == "All people" & sex == "All people") %>% 
         select(hb_name, hb_population) %>%
        mutate(hb_name = paste("NHS", hb_name))
```

Comparing with covid data 
```{r}
july_2020_data <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/80b6ddb1-f09b-4d76-9927-da1e118b01ff/download/pitc202007.csv") %>% 
  clean_names()
```

Join with Health board names and population data

```{r}
july_2020_data_health_boards <- july_2020_data %>% 
  left_join(health_board_names, by = join_by(hbt == hb))

july_2020_data_health_boards_population <- july_2020_data_health_boards %>% 
   left_join(population, by = join_by(hb_name == hb_name))
  
```

Organising data: Filtering to select only antibiotic prescriptions, totalling up these for each healthboard, and grouping by health board and type of antibiotic.
```{r}
july_2020_data_health_boards_population <- july_2020_data_health_boards_population %>% 
   filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  group_by(hb_name, bnf_item_description) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  filter(!is.na(hb_name)) %>% 
  left_join(population)

```

Calculating the number of antibiotics administered per person in each healthboard in july 2020
```{r}
antibiotics_per_person_data_2020 <-july_2020_data_health_boards_population %>% 
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  left_join(population) %>% 
  mutate(antibiotics_per_person = paid_quantity/hb_population) 

```

PLotting this data 
```{r}
p2020 <- antibiotics_per_person_data_2020 %>% 
  mutate(hb_name = fct_reorder(hb_name, antibiotics_per_person)) %>% 
  ggplot(aes(x = hb_name, y = antibiotics_per_person, fill = hb_name, colour = hb_name)) +
  geom_col() +
    labs(x = "Health Board Name", y = "Number of Antibiotics per person in July 2020", title = "Number of Antibiotics Prescribed per person in July 2020") 

```

comparing post and during covid with pre covid data
```{r}
july_2016_data <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/c12c905b-3a2d-4b7a-b5d2-8c359b786beb/download/pitc201607.csv") %>% 
  clean_names()
```

joining with health board and population data 

```{r}
july_2016_data_health_boards <- july_2016_data %>% 
  left_join(health_board_names, by = join_by(hbt2014 == hb))

july_2016_data_health_boards_population <- july_2016_data_health_boards %>% 
   left_join(population, by = join_by(hb_name == hb_name))
```

Organising the data 

```{r}
july_2016_data_health_boards_population <- july_2016_data_health_boards_population %>% 
   filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  group_by(hb_name, bnf_item_description) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  filter(!is.na(hb_name)) %>% 
  left_join(population)

```
calculating the numbers of ab per person in each health board in 2016
```{r}
antibiotics_per_person_data_2016 <-july_2016_data_health_boards_population %>% 
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  left_join(population) %>% 
  mutate(antibiotics_per_person = paid_quantity/hb_population) 
```

Plotting this data 
```{r}
p2016 <- antibiotics_per_person_data_2016 %>% 
  mutate(hb_name = fct_reorder(hb_name, antibiotics_per_person)) %>% 
  ggplot(aes(x = hb_name, y = antibiotics_per_person, fill = hb_name, colour = hb_name)) +
  geom_col() +
    labs(x = "Health Board Name", y = "Number of Antibiotics per person in July 2016", title = "Number of Antibiotics Prescribed per person in July 2016") 

```

Joining all years july data for comparison
```{r}

Joined_prescription_data <- antibiotics_per_person_data_2016 %>% 
  left_join(antibiotics_per_person_data)

Joined_prescription_data_all <- Joined_prescription_data %>% 
  left_join(antibiotics_july_data)

#is there a way to join this so values are not averaged, maybe ill try plotting and facet wrapping to see what this does 
```
Plotting all data 
```{r}
Joined_prescription_data_all %>% 
  ggplot(aes(x = hb_name, y = antibiotics_per_person), fill = hb_name) +
  geom_col() +
   labs(x = "Health Board Name", y = "Number of Antibiotics per person", title = "Number of Antibiotics Prescribed per person in July 2016, July 2020, July 2025") 

```

Adding all graphs together 
```{r}
library(janitor )
p2016 + p2020 + p2025

```

Investigating most common types of ab prescribed in each hb across pre, during and post covid 
```{r}

july_2016_ab_type <- july_2016_data %>% 
  left_join(health_board_names, by = join_by(hbt2014 == hb)) %>% 
  select(paid_quantity, hb_name, bnf_item_description, paid_date_month) %>% 
  left_join(population, by = join_by(hb_name == hb_name)) 
  

```


```{r}
july_2016_ab_type <- july_2016_ab_type %>% 
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  group_by(bnf_item_description, hb_name, paid_date_month) %>% 
  summarise(paid_quantity = sum(paid_quantity)) 
```

```{r}
july_2016_ab_type_top_10 <- july_2016_ab_type %>% 
  arrange(desc(paid_quantity)) %>% 
  slice_max(paid_quantity, n = 10)
```

type data, doesnt take into account amount per person though, but probs not that relevant here 
```{r}
july_2016_ab_type_top_10 %>% 
  ggplot(aes(x = bnf_item_description, y = paid_quantity, fill = bnf_item_description)) +
  geom_col() +
  facet_wrap(~hb_name)
```

Create a tibble of all data, and compare year against ab per person ?
```{r}
All_years <- july_2020_data %>% 
  left_join(july_2016_data, by = join_by( hbt== hbt2014, bnf_item_description == bnf_item_description, paid_quantity == paid_quantity, paid_date_month == paid_date_month)) %>% 
  left_join(july_2025_data, by = join_by(hbt == hbt, bnf_item_description == bnf_item_description, paid_quantity == paid_quantity, paid_date_month == paid_date_month))
```


```{r}
All_years_hb <- All_years %>% 
  left_join(health_board_names, by = join_by(hbt == hb))

All_years_filtered <- All_years_hb %>% 
  select(bnf_item_description, hb_name, paid_quantity, paid_date_month) %>% 
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  group_by(hb_name, bnf_item_description, paid_date_month) %>% 
  summarise(paid_quantity = sum(paid_quantity)) %>% 
  arrange(desc(paid_quantity)) %>% 
  filter(!is.na (hb_name))

All_years_filtered %>% 
  ggplot(aes(x = bnf_item_description, y = paid_quantity, fill = hb_name)) +
  geom_col() +
  facet_wrap(~paid_date_month)

  