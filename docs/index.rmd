---
title: "Assessment"
output: html_document
date: "2025-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Loading in prescription data sets and health board names from open nhs data. loading population data from the census age by sex dataset 
```{r}
library(tidyverse)
library(janitor)
library(here)


july_2025_data <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f02161c1-15f6-4d9f-8be5-01ba613d4303/download/hb_pitc2025_07.csv") %>% 
  clean_names()

july_2020_data <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/80b6ddb1-f09b-4d76-9927-da1e118b01ff/download/pitc202007.csv") %>% 
  clean_names()

july_2016_data <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/c12c905b-3a2d-4b7a-b5d2-8c359b786beb/download/pitc201607.csv") %>% 
  clean_names()

health_board_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

population <- read_csv(here("data", "healthboardpopulationbyage.csv"), skip = 10) %>% 
  clean_names()  

  #maybe need to load previous census population data too

```

Joining prescription Dataset from all years, with health boards names. 
```{r}
hb_data_2025 <- july_2025_data %>%
  left_join(health_board_names, by = join_by(hbt == hb)) 

hb_data_2020 <- july_2020_data %>%
  left_join(health_board_names, by = join_by(hbt == hb)) 

hb_data_2016 <- july_2016_data %>%
  left_join(health_board_names, by = join_by(hbt2014 == hb)) 

```

Wrangling with population data to compare with prescription health board data
```{r}
population <- population %>% 
rename(Spare = "x6",
         hb_name = "health_board_area_2019",
         hb_population = count) %>% 
  filter(age == "All people" & sex == "All people") %>% 
         select(hb_name, hb_population) %>%
        mutate(hb_name = paste("NHS", hb_name)) 
  
```

Filtering for just ab and selecting specific columns: paid_quantity, paid_date_month, hb_name, bnf_item_description
```{r}
july_2016_ab <- data_2016 %>%
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  select(bnf_item_description, hb_name, paid_quantity, paid_date_month) %>% 
  group_by(bnf_item_description, hb_name, paid_date_month)

july_2020_ab <- data_2020 %>%
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  select(bnf_item_description, hb_name, paid_quantity, paid_date_month) %>% 
    group_by(bnf_item_description, hb_name, paid_date_month)
  
july_2025_ab <- data_2025 %>%
  filter(str_detect(bnf_item_description, "CILLIN")) %>% 
  select(bnf_item_description, hb_name, paid_quantity, paid_date_month) %>% 
    group_by(bnf_item_description, hb_name, paid_date_month)

```

Join this data together

```{r}
all_ab_data <- july_2025_ab %>% 
  full_join(july_2020_ab) %>% 
  full_join(july_2016_ab)
```


Wrangling with prescription data. Selecting only antibioitic prescriptions. Renaming antibiotocs to just their name so they can be totalled, instead of having different doses of each antibiotic. Also changing paid_date_month to just say the year, since all data is from july.  *need to do same with months now*
```{r}
library(dplyr)
library(stringr)

all_ab_data_tidy <- all_ab_data %>% 
  rename(Year = paid_date_month, `Antibiotic Type` = bnf_item_description, 'Prescription Number' = paid_quantity) %>% 
  mutate(
    `Antibiotic Type` = case_when(
      str_starts(`Antibiotic Type`, "AMOX") ~ "AMOXICILLIN",
      str_starts(`Antibiotic Type`, "BENZYL") ~ "BENZYLPENICILLIN",
      str_starts(`Antibiotic Type`, "PHENO") ~ "PHENOXYMETHYLPENICILLIN",
      str_starts(`Antibiotic Type`, "PIV") ~ "PIVMECILLINAM",
      str_starts(`Antibiotic Type`, "AMPI") ~ "AMPICILLIN",
      str_starts(`Antibiotic Type`, "FLU") ~ "FLUCLOXACILLIN",
      TRUE ~ `Antibiotic Type`
    ),
    Year = as.character(Year),
    Year = case_when(
      str_starts(Year, "2020") ~ "2020",
      str_starts(Year, "2025") ~ "2025",
      str_starts(Year, "2016") ~ "2016",
      TRUE ~ Year
    )
  ) %>% 
  group_by(`Antibiotic Type`, hb_name, Year) %>% 
  filter(!is.na(hb_name)) %>% 
  summarise(paid_quantity = sum(paid_quantity))


```

Joining Population with prescription data 
```{r}
tidy_ab_data_pop <-  population %>%
  left_join(all_ab_data_tidy, by = join_by(hb_name == hb_name))
```

Working out ab per person
```{r}
all_ab_data_tidy_person <- tidy_ab_data_pop %>% 
  mutate(Ab_Per_Person = (paid_quantity/hb_population))
```
Plot 1 this: ab per person admionistered across different years 
```{r}
all_ab_data_tidy_person %>% 
  ggplot(aes(x = hb_name, y = Ab_Per_Person, fill = `Antibiotic Type`)) +
  geom_col(show.legend = TRUE) +
  labs(
    x = "Health Board Name", 
    y = "Antibiotic Quantity Per Person", 
    title = "Different in Number of Antibiotics Prescribed per person, Before, During and After Covid 19 Pandemic", 
    fill = "Antibiotic Type") +
  facet_wrap(~Year) +
  theme_minimal(base_size = 14) +  # Cleaner, more modern look
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12), # Tilt x-axis labels for readability
    axis.text.y = element_text(size = 12),
    axis.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", size = 16, hjust = 0),
    legend.position = "bottom",  # Move legend below plot
    legend.title = element_text(face = "bold", size = 13),
    legend.text = element_text(size = 12),
    panel.grid.major = element_line(color = "grey85"),
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold", size = 13)) +
  guides(fill = guide_legend(nrow = 1))

```
PLot 2 but looking at which hb has biggest difference between years in prescribing
```{r}
all_ab_data_tidy_person %>% 
  ggplot(aes(x = Year, y = Ab_Per_Person, fill = `Antibiotic Type`)) +
  geom_col(show.legend = TRUE) +
  labs(
    x = "Health Board Name", 
    y = "Antibiotic Quantity Per Person", 
    title = "Different in Number of Antibiotics Prescribed per person, Before, During and After Covid 19 Pandemic", 
    fill = "Antibiotic Type") +
  facet_wrap(~hb_name) +
  theme_minimal(base_size = 14) +  # Cleaner, more modern look
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12), # Tilt x-axis labels for readability
    axis.text.y = element_text(size = 12),
    axis.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", size = 16, hjust = 0),
    legend.position = "bottom",  # Move legend below plot
    legend.title = element_text(face = "bold", size = 13),
    legend.text = element_text(size = 12),
    panel.grid.major = element_line(color = "grey85"),
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold", size = 13)) +
  guides(fill = guide_legend(nrow = 1))
```


Table containing data about antibiotic type, total number, number per person, across the 3 years and different healthboards *need to ask whether i need to use old census data for 2016 and 2020*, also need to ask if i should look at more months or just these months 

```{r}

```


PLOT3
Nicer plot of ab types across diff years, doesnt look at healthbioards though, maybe make a map of this to se that?
```{r}
library(ggplot2)
library(dplyr)

all_ab_data_tidy %>% 
  ggplot(aes(x = 'Antibiotic Type', y = paid_quantity, fill = 'Antibiotic Type')) +
  geom_violin(show.legend = TRUE) +
  labs(
    x = "Antibiotic Type", 
    y = "Antibiotic Quantity", 
    title = "Different Types of Antibiotics Prescribed, Before, During and After Covid 19 Pandemic", 
    fill = "Antibiotic Type"
  ) +
  facet_wrap(~Year) +
  theme_minimal(base_size = 14) +  # Cleaner, more modern look
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12), # Tilt x-axis labels for readability
    axis.text.y = element_text(size = 12),
    axis.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", size = 16, hjust = 0),
    legend.position = "bottom",  # Move legend below plot
    legend.title = element_text(face = "bold", size = 13),
    legend.text = element_text(size = 12),
    panel.grid.major = element_line(color = "grey85"),
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold", size = 13)
  ) +
  guides(fill = guide_legend(nrow = 1))  # Put legend items in one row for compactness

#need to add a written legend to this
```

Tibble summary of results 

```{r}

```

