---
title: "Examining the differences in Antibiotic Prescriptions across Scottish health boards, before (2016), During (2020) and after (2024) Covid-19"
output: html_document
date: "2025-14-11"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```
Loading R packages that will be needed at this point. Tidyverse needed for most functions, ggplot etc. Purr needed to make own function, janitor needed to 
```{r}
library(tidyverse)
library(janitor)
library(here)
library(purrr)
```
loading data, using function, and filtering for desired df
```{r}
set_of_urls <- c("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7c487db9-f450-4319-8b18-4b825380692b/download/pitc201601.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0727befa-5530-4c1d-aff0-ccb7554eff7a/download/pitc201602.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/20ad9575-4bd7-4bf4-af41-fd36071e2301/download/pitc201603.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e44eb789-b8e0-41d9-a264-eba18b2d2473/download/pitc201604.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/90ebb5ed-bc22-4bbc-8915-d55ae9d9906e/download/pitc201605.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/a636862a-77e0-4c97-ba97-268578534a8e/download/pitc201606.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/c12c905b-3a2d-4b7a-b5d2-8c359b786beb/download/pitc201607.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/bbd1d028-b9c6-4a28-b579-eafcaaa44703/download/pitc201608.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2e0d6f14-3752-4c42-9a02-34d867132737/download/pitc201609.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f22c20c1-6066-4f7d-a939-3ae654d1467a/download/pitc201610.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/5d421ba3-ccba-4d98-9772-e2e042b29a0f/download/pitc201611.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/597ea4bc-f733-45b6-8a60-5d7a6ac4824c/download/pitc201612.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e5c841f2-3e16-428b-97db-0798ec7a5fb4/download/pitc202001.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/af121e7c-4124-4955-92e9-a9580ccd469e/download/pitc202002.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9581bd8d-5568-4462-93a6-6d7bfbbe7cbc/download/pitc202003.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/9cdc0526-21ab-43de-b832-bc032cd31b24/download/pitc202004.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f2ffa7b3-3f93-470a-8125-880afb9aafe0/download/pitc202005.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/64131d22-ab47-43ff-9674-ebe8ed7edbd7/download/pitc202006.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/80b6ddb1-f09b-4d76-9927-da1e118b01ff/download/pitc202007.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/5fd5f56e-d1d2-4f22-b4f7-224fbd50dca3/download/pitc202008.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/e1b0cfdd-d184-4ebc-bd93-f1a10d84ead0/download/pitc202009.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/83bf4892-d246-41f8-a6ca-d44d18e2a2ca/download/pitc202010.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/ab8aa642-2562-4abb-a360-5c5f9e7e349c/download/pitc202011.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0c033702-4d88-4f2d-989c-a709b1f4529e/download/pitc202012.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f0df380b-3f9b-4536-bb87-569e189b727a/download/hb_pitc2024_01_06-1.csv", "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/f3b9f2e2-66c0-4310-9b8e-734781d2ed0a/download/hb_pitc2024_07_12-1.csv")

example_url <- c("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/0727befa-5530-4c1d-aff0-ccb7554eff7a/download/pitc201602.csv")

process_csv <- function(url) {
  prescription_data <- read_csv(url) %>% clean_names() %>% 
 rename_with(.fn = ~ ifelse(.x %in% c("hbt2014", "hbt"), "hb", .x))
  
prescription_data <- prescription_data %>% 
 rename(year = paid_date_month, antibiotic_type = bnf_item_description, prescription_number = paid_quantity) %>%
    select(hb, antibiotic_type, prescription_number, year) %>%
    filter(str_detect(antibiotic_type, "CILLIN"), !is.na(hb)) %>%
    mutate(antibiotic_type = case_when(str_starts(antibiotic_type, "AMOX") ~ "AMOXICILLIN", str_starts(antibiotic_type, "BENZYL") ~ "BENZYLPENICILLIN", str_starts(antibiotic_type, "PHENO") ~ "PHENOXYMETHYLPENICILLIN", str_starts(antibiotic_type, "PIV") ~ "PIVMECILLINAM", str_starts(antibiotic_type, "PIPE") ~ "PIPERACILLIN", str_starts(antibiotic_type, "AMPI") ~ "AMPICILLIN", str_starts(antibiotic_type, "FLU") ~ "FLUCLOXACILLIN", TRUE ~ antibiotic_type),year = case_when(str_starts(year, "2020") ~ "2020", str_starts(year, "2024") ~ "2024", str_starts(year, "2016") ~ "2016", TRUE ~ as.character(year))) %>%
    group_by(year, antibiotic_type, hb) %>%
    summarise(prescription_number = sum(prescription_number, na.rm = TRUE), .groups = "drop")
}
#running example using function
example <- process_csv(example_url)
#running function with data
combined_prescription_data <- map_dfr(set_of_urls, process_csv)

```
loading hb_names and population data, tidying and joining with prescription data
```{r}
health_board_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% clean_names()

population <- read_csv(here("data", "healthboardpopulationbyage.csv"), skip = 10) %>% 
  clean_names() %>% 
  rename(Spare = "x6",
         hb_name = "health_board_area_2019",
         health_board_population = count) %>% 
  filter(age == "All people" & sex == "All people") %>% 
         select(hb_name, health_board_population) %>%
        mutate(hb_name = paste("NHS", hb_name)) 

all_prescription_and_hb_data <- combined_prescription_data %>% 
  full_join(health_board_names) %>% 
  full_join(population) %>% 
  select(year, antibiotic_type, prescription_number, hb_name, health_board_population)
```
plot of prescription numbers across health boards each year
```{r}
library(dplyr)
library(stringr)
all_prescription_and_hb_data %>% 
  ggplot(aes(x = hb_name, y = prescription_number, fill = antibiotic_type)) +
  geom_col(show.legend = TRUE) +
  labs(x = "Health Board Name", 
    y = "Antibiotic Quantity Per Health Board", 
    title = "Different in Number of Antibiotics Prescribed per Health Board, Before, During and After Covid 19 Pandemic", 
    fill = "Antibiotic Type") +
  facet_wrap(~year) +
  theme_minimal(base_size = 14) +  # Cleaner, more modern look
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12), # Tilt x-axis labels for readability
    axis.text.y = element_text(size = 12),
    axis.title = element_text(face = "bold", size = 14),
    plot.title = element_text(face = "bold", size = 16, hjust = 0),
    legend.position = "bottom",  # Move legend below plot
    legend.title = element_text(face = "bold", size = 13),
    legend.text = element_text(size = 12),
    panel.grid.major = element_line(color = "grey85"),
    panel.grid.minor = element_blank(),
    strip.text = element_text(face = "bold", size = 13)) +
  guides(fill = guide_legend(nrow = 1))
```


